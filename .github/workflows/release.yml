name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build app bundle
      run: |
        chmod +x build_app.sh
        ./build_app.sh
    
    - name: Create Release ZIP
      run: |
        cd .build/dist
        # Ensure we have a clean zip
        rm -f NetSpeedMonitor.zip
        zip -r NetSpeedMonitor.zip NetSpeedMonitor.app
        
    - name: Calculate SHA256
      id: sha256
      run: |
        cd .build/dist
        SHA256=$(shasum -a 256 NetSpeedMonitor.zip | awk '{print $1}')
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "SHA256: $SHA256"
    
    - name: Get version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=$(git describe --tags --always)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: .build/dist/NetSpeedMonitor.zip
        body: |
          NetSpeed Monitor v${{ steps.version.outputs.version }}
          
          ## Installation
          
          ### Via Homebrew (Recommended)
          ```bash
          brew tap guerrerocarlos/tap
          brew install --cask netspeedmonitor
          ```
          
          ### Manual Installation
          1. Download NetSpeedMonitor.zip
          2. Extract the zip file
          3. Move NetSpeedMonitor.app to /Applications/
          4. Remove quarantine attribute:
             ```bash
             sudo xattr -rd com.apple.quarantine /Applications/NetSpeedMonitor.app
             ```
          
          ## SHA256 Checksum
          ```
          ${{ steps.sha256.outputs.sha256 }}
          ```
          
          ## System Requirements
          - macOS 14.0 (Sonoma) or later
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Homebrew Cask
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "SHA256 for Homebrew cask: ${{ steps.sha256.outputs.sha256 }}"
        echo "Update the sha256 in Casks/netspeedmonitor.rb with this value"
        echo "Version: ${{ steps.version.outputs.version }}"
